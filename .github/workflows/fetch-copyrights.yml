name: Extract components & fetch copyrights

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate SBOM files exist
        run: |
          set -euo pipefail
          test -f "sboms/spdx-lite.json" || { echo "Missing sboms/spdx-lite.json" >&2; exit 1; }
          test -f "sboms/cyclonedx.json" || { echo "Missing sboms/cyclonedx.json" >&2; exit 1; }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y git-lfs xz-utils
          git lfs install

      - name: Generate components.json from SBOMs
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, re, urllib.parse

          SPDX_PATH = "sboms/spdx-lite.json"
          CDX_PATH  = "sboms/cyclonedx.json"

          def load_json(path):
              if not os.path.exists(path): return None
              with open(path, 'r', encoding='utf-8') as f: return json.load(f)

          def extract_from_purl(purl):
              if not purl: return (None, None, None)
              s = purl.strip()
              if s.startswith("pkg:"): s = s[4:]
              s = s.split('#', 1)[0].split('?', 1)[0]
              version = None
              base = s
              if '@' in s: base, version = s.rsplit('@', 1)
              component = urllib.parse.unquote(base.split('/')[-1])
              git_url = None
              m = re.search(r'(github\.com|gitlab\.com|bitbucket\.org)/([^/?#]+)/([^/?#]+)', base)
              if m:
                  host, owner, repo = m.groups()
                  git_url = f"https://{host}/{owner}/{repo.rstrip('.git')}.git"
              return (component, version, git_url)

          def parse_cyclonedx(path):
              out = []
              data = load_json(path)
              if not data: return out
              for c in data.get("components", []):
                  purl = c.get("purl")
                  name, ver, git_url = extract_from_purl(purl)
                  if not name: name = c.get("name")
                  if not ver: ver = c.get("version")
                  out.append({"component": name, "version": ver, "git_url": git_url})
              return out

          def parse_spdx(path):
              out = []
              data = load_json(path)
              if not data: return out
              for p in data.get("packages", []):
                  name = p.get("name") or p.get("packageName")
                  ver = p.get("versionInfo")
                  purl = None
                  for ref in p.get("externalRefs", []):
                      if (ref.get("referenceType") or "").lower() == "purl":
                          purl = ref.get("referenceLocator")
                          break
                  name2, ver2, git_url = extract_from_purl(purl)
                  if name2: name = name2
                  if not ver: ver = ver2
                  out.append({"component": name, "version": ver, "git_url": git_url})
              return out

          comps = parse_cyclonedx(CDX_PATH) + parse_spdx(SPDX_PATH)
          seen, result = set(), []
          for c in comps:
              key = (c["component"], c.get("version") or "", c.get("git_url") or "")
              if key in seen: continue
              seen.add(key)
              result.append(c)

          os.makedirs("artifacts", exist_ok=True)
          with open("artifacts/components.json", "w") as f:
              json.dump({"components": result}, f, indent=2)
          print(f"Wrote {len(result)} components.")
          PY

      - name: Upload components.json
        uses: actions/upload-artifact@v4
        with:
          name: components-json
          path: artifacts/components.json

      - name: Install ScanCode Toolkit (latest stable)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p scancode && cd scancode
          REL_JSON=$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/nexB/scancode-toolkit/releases/latest)
          ASSET_URL=$(echo "$REL_JSON" | grep -o '"browser_download_url": *"[^"]*"' \
            | grep -E 'linux(_|-)?x86_64.*\.tar\.xz|linux_64.*\.tar\.xz' \
            | head -n 1 | sed 's/"browser_download_url": *"//;s/"$//')
          if [ -z "$ASSET_URL" ]; then echo "No ScanCode asset found." >&2; exit 1; fi
          echo "Downloading: $ASSET_URL"
          curl -fsSL "$ASSET_URL" -o scancode.tar.xz
          tar -xf scancode.tar.xz
          SCANCODE_DIR=$(ls -d scancode-toolkit-* | head -n 1)
          echo "SCANCODE=$PWD/$SCANCODE_DIR/scancode" >> "$GITHUB_ENV"

      - name: Clone repos and run ScanCode
        env:
          SCANCODE: ${{ env.SCANCODE }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, subprocess, shlex, re
          SCANCODE = os.environ["SCANCODE"]
          with open("artifacts/components.json") as f:
              comps = json.load(f)["components"]
          os.makedirs("repos", exist_ok=True)
          os.makedirs("scancode_results", exist_ok=True)

          def sanitize(s): return re.sub(r'[^A-Za-z0-9_.-]+', '-', s or "")
          def run(cmd): return subprocess.run(cmd, shell=True)

          results = []
          for c in comps:
              name, ver, url = c["component"], c.get("version"), c.get("git_url")
              if not url:
                  results.append({"component": name, "version": ver, "git_url": url, "copyrights": []})
                  continue
              dest = f"repos/{sanitize(name)}"
              if ver: dest += f"-{sanitize(ver)}"
              if not os.path.exists(dest):
                  if ver:
                      run(f"git clone --depth 1 --branch {shlex.quote(ver)} {shlex.quote(url)} {shlex.quote(dest)}")
                  else:
                      run(f"git clone --depth 1 {shlex.quote(url)} {shlex.quote(dest)}")
              out_json = f"scancode_results/{sanitize(name)}.json"
              run(f"{shlex.quote(SCANCODE)} --copyright --strip-root --json-pp {shlex.quote(out_json)} {shlex.quote(dest)}")
              copyrights = set()
              try:
                  with open(out_json) as f: data = json.load(f)
                  for file in data.get("files", []):
                      for cpy in file.get("copyrights", []):
                          for stmt in cpy.get("statements", []):
                              if stmt.strip(): copyrights.add(stmt.strip())
              except: pass
              results.append({"component": name, "version": ver, "git_url": url, "copyrights": sorted(copyrights)})

          os.makedirs("artifacts", exist_ok=True)
          with open("artifacts/component_copyrights.json", "w") as f:
              json.dump({"components": results}, f, indent=2)
          PY

      - name: Upload final copyrights
        uses: actions/upload-artifact@v4
        with:
          name: component-copyrights
          path: artifacts/component_copyrights.json
