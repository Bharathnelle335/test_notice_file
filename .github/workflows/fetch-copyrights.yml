name: Extract components & fetch copyrights

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

permissions:
  contents: read

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate SBOM files exist
        run: |
          set -euo pipefail
          test -f "sboms/spdx-lite.json" || { echo "Missing sboms/spdx-lite.json" >&2; exit 1; }
          test -f "sboms/cyclonedx.json" || { echo "Missing sboms/cyclonedx.json" >&2; exit 1; }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install prerequisites
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y git-lfs xz-utils
          git lfs install

      - name: Generate components.json from SBOMs
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, re, urllib.parse

          SPDX_PATH = "sboms/spdx-lite.json"
          CDX_PATH  = "sboms/cyclonedx.json"

          def load_json(path):
              if not os.path.exists(path): return None
              with open(path, 'r', encoding='utf-8') as f: return json.load(f)

          def last_segment(name: str|None):
              if not name: return None
              s = name
              for sep in ('/', ':'):
                  if sep in s: s = s.split(sep)[-1]
              return s

          def extract_from_purl(purl):
              """
              component: last path segment of the purl before @version
              version: from @version if present
              git_url: inferred for GitHub/GitLab/Bitbucket purls
              """
              if not purl: return (None, None, None)
              s = purl.strip()
              if s.startswith("pkg:"): s = s[4:]
              s = s.split('#', 1)[0].split('?', 1)[0]
              version = None
              base = s
              if '@' in s:
                  base, version = s.rsplit('@', 1)
              component = urllib.parse.unquote(base.split('/')[-1])
              git_url = None
              m = re.search(r'(github\\.com|gitlab\\.com|bitbucket\\.org)/([^/?#]+)/([^/?#]+)', base)
              if m:
                  host, owner, repo = m.groups()
                  repo = repo.rstrip('.git')
                  git_url = f"https://{host}/{owner}/{repo}.git"
              return (component, version, git_url)

          def parse_cyclonedx(path):
              out = []
              data = load_json(path)
              if not data: return out
              for c in data.get("components", []):
                  purl = c.get("purl")
                  name_p, ver_p, git_p = extract_from_purl(purl) if purl else (None, None, None)
                  name = name_p or last_segment(c.get("name"))
                  version = c.get("version") or ver_p
                  git_url = git_p
                  if name:
                      out.append({"component": name, "version": version, "git_url": git_url})
              return out

          def parse_spdx(path):
              out = []
              data = load_json(path)
              if not data: return out
              pkgs = data.get("packages") or []
              for p in pkgs:
                  name = last_segment(p.get("name") or p.get("packageName"))
                  version = p.get("versionInfo")
                  purl = None
                  for ref in p.get("externalRefs", []) or []:
                      rtype = (ref.get("referenceType") or ref.get("type") or "").lower()
                      loc = ref.get("referenceLocator") or ref.get("locator")
                      if rtype == "purl" and loc:
                          purl = loc
                          break
                  name_p, ver_p, git_p = extract_from_purl(purl) if purl else (None, None, None)
                  if name_p: name = name_p
                  if not version: version = ver_p
                  git_url = git_p
                  if name:
                      out.append({"component": name, "version": version, "git_url": git_url})
              return out

          # Parse, merge, de-duplicate
          comps = parse_cyclonedx(CDX_PATH) + parse_spdx(SPDX_PATH)
          seen, result = set(), []
          for c in comps:
              key = (c["component"], c.get("version") or "", c.get("git_url") or "")
              if key in seen: continue
              seen.add(key)
              result.append(c)

          os.makedirs("artifacts", exist_ok=True)
          with open("artifacts/components.json", "w", encoding="utf-8") as f:
              json.dump({"components": result}, f, indent=2, ensure_ascii=False)
          print(f"Wrote artifacts/components.json with {len(result)} components.")
          PY

      - name: Upload components.json
        uses: actions/upload-artifact@v4
        with:
          name: components-json
          path: artifacts/components.json

      - name: Install ScanCode Toolkit (hardcoded v32.4.1 for Python 3.11, Linux)
        run: |
          set -euo pipefail
          mkdir -p scancode && cd scancode
          ASSET_URL="https://github.com/aboutcode-org/scancode-toolkit/releases/download/v32.4.1/scancode-toolkit-v32.4.1_py3.11-linux.tar.gz"
          echo "Downloading: $ASSET_URL"
          curl -fsSL "$ASSET_URL" -o scancode.tar.gz
          tar -xzf scancode.tar.gz
          SCANCODE_DIR=$(ls -d scancode-toolkit-* | head -n 1)
          if [ -z "${SCANCODE_DIR:-}" ]; then
            echo "Extraction failed: scancode-toolkit-* directory not found." >&2
            exit 1
          fi
          echo "SCANCODE=$PWD/$SCANCODE_DIR/scancode" >> "$GITHUB_ENV"
          echo "SCANCODE_DIR=$PWD/$SCANCODE_DIR" >> "$GITHUB_ENV"
          echo "Installed ScanCode at $SCANCODE_DIR"

      - name: Clone repos and run ScanCode (simple version rule)
        env:
          SCANCODE: ${{ env.SCANCODE }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, subprocess, shlex, re

          SCANCODE = os.environ["SCANCODE"]
          with open("artifacts/components.json", "r", encoding="utf-8") as f:
              comps = json.load(f).get("components", [])

          os.makedirs("repos", exist_ok=True)
          os.makedirs("scancode_results", exist_ok=True)

          def sanitize(s): return re.sub(r'[^A-Za-z0-9_.-]+', '-', (s or "")).strip('-') or "unknown"
          def run(cmd):
              print("+", cmd)
              return subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)

          results = []
          for item in comps:
              name = item.get("component")
              version = item.get("version")
              git_url = item.get("git_url")

              if not name:
                  continue

              if not git_url:
                  results.append({"component": name, "version": version, "git_url": git_url, "copyrights": []})
                  continue

              dest = os.path.join("repos", sanitize(name) + (f"-{sanitize(version)}" if version else ""))
              if not os.path.exists(dest):
                  if version:
                      p = run(f"git clone --depth 1 --branch {shlex.quote(version)} {shlex.quote(git_url)} {shlex.quote(dest)}")
                      if p.returncode != 0:
                          print(p.stdout)
                          results.append({"component": name, "version": version, "git_url": git_url, "copyrights": []})
                          continue
                  else:
                      p = run(f"git clone --depth 1 {shlex.quote(git_url)} {shlex.quote(dest)}")
                      if p.returncode != 0:
                          print(p.stdout)
                          results.append({"component": name, "version": version, "git_url": git_url, "copyrights": []})
                          continue

              out_json = os.path.join("scancode_results", sanitize(name) + ".json")
              cmd = f"{shlex.quote(SCANCODE)} --copyright --strip-root --json-pp {shlex.quote(out_json)} {shlex.quote(dest)}"
              p = run(cmd)
              if p.returncode != 0:
                  print(p.stdout)

              copyrights = set()
              try:
                  with open(out_json, "r", encoding="utf-8") as f:
                      data = json.load(f)
                  for file_entry in data.get("files", []):
                      for c in file_entry.get("copyrights", []):
                          for stmt in c.get("statements", []) or []:
                              stmt = (stmt or "").strip()
                              if stmt:
                                  copyrights.add(stmt)
              except Exception as e:
                  print(f"Parse failed for {name}: {e}")

              results.append({
                  "component": name,
                  "version": version,
                  "git_url": git_url,
                  "copyrights": sorted(copyrights)
              })

          os.makedirs("artifacts", exist_ok=True)
          with open("artifacts/component_copyrights.json", "w", encoding="utf-8") as f:
              json.dump({"components": results}, f, indent=2, ensure_ascii=False)

          print(f"Wrote artifacts/component_copyrights.json for {len(results)} components.")
          PY

      - name: Upload raw ScanCode outputs (optional)
        uses: actions/upload-artifact@v4
        with:
          name: scancode-raw
          path: scancode_results/*.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload final aggregated copyrights
        uses: actions/upload-artifact@v4
        with:
          name: component-copyrights
          path: artifacts/component_copyrights.json
          if-no-files-found: error
          retention-days: 30
