name: Generate NOTICE (matrix + ScanCode)

on:
  workflow_dispatch:
    inputs:
      sbom_paths:
        description: "Comma-separated SBOM JSON paths (SPDX or CycloneDX)"
        required: true
        default: "sboms/spdx-lite.json,sboms/cyclonedx.json"
      notice_title:
        description: "Title for NOTICE.md"
        required: false
        default: "Open Source Notices"

  push:
    branches: [ main, master ]
    paths:
      - "sboms/**/*.json"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.build.outputs.matrix_json }}
      title: ${{ steps.build.outputs.title }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install parsers
        run: |
          python -m pip install --upgrade pip
          pip install requests packaging cyclonedx-python-lib==0.11.1 spdx-tools
      - name: Build matrix from SBOMs
        id: build
        run: |
          # Save matrix JSON to a file
          python prepare_matrix.py > matrix.json
          # Output the JSON and title
          echo "matrix_json=$(cat matrix.json)" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.inputs.notice_title || 'Open Source Notices' }}" >> $GITHUB_OUTPUT

  show_summary:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Show components count
        run: |
          echo "### Prepared components for scanning"
          python -c "import json, os; m=json.loads(os.environ['M']); print(f'- Components to scan: {len(m.get(\"include\", []))}')"
        env:
          M: ${{ needs.prepare.outputs.matrix_json }}

  scan_components:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix_json) }}
      max-parallel: 12
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install scan dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scancode-toolkit requests packaging
      - name: Download and scan component source
        run: python download_and_scan.py
        env:
          NAME: ${{ matrix.name }}
          VERSION: ${{ matrix.version }}
          URL: ${{ matrix.url }}
          PURL: ${{ matrix.purl }}
          SAFE_NAME: ${{ matrix.safe_name }}

  merge:
    needs: [prepare, scan_components]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "scan-*"
          path: scans
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install helper libs
        run: |
          python -m pip install --upgrade pip
          pip install requests packaging
      - name: Build NOTICE.md from scan data
        run: |
          python build_notice.py
        env:
          TITLE: ${{ needs.prepare.outputs.title }}
      - name: Upload NOTICE.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: notice-md
          path: NOTICE.md
      - name: Commit NOTICE.md back (optional)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add NOTICE.md
          git diff --cached --quiet || git commit -m "chore: update NOTICE.md (matrix ScanCode)"
          git push
