name: Scan Components from SPDX and CycloneDX

on:
  workflow_dispatch:
    inputs:
      spdx_json:
        description: 'Path to SPDX-lite JSON'
        required: true
        default: 'sboms/spdx-lite.json'
      cyclonedx_json:
        description: 'Path to CycloneDX JSON'
        required: true
        default: 'sboms/cyclonedx.json'
      notice_title:
        description: 'NOTICE.md title'
        required: false
        default: 'Open Source Notices'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.set_outputs.outputs.matrix_json }}
      title: ${{ steps.set_outputs.outputs.title }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install spdx-tools cyclonedx-python-lib requests
      - name: Extract components and create matrix.json
        id: extract_components
        run: python scripts/extract_components.py --spdx ${{ github.event.inputs.spdx_json }} --cdx ${{ github.event.inputs.cyclonedx_json }}
      - name: Show matrix.json content (debug)
        run: cat matrix.json
      - name: Set outputs
        id: set_outputs
        run: |
          CONTENT=$(python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))' < matrix.json)
          echo "matrix_json=$CONTENT" >> $GITHUB_OUTPUT
          echo "title=${{ github.event.inputs.notice_title || 'Open Source Notices' }}" >> $GITHUB_OUTPUT

  scan:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix_json) }}
      max-parallel: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install ScanCode Toolkit
        run: pip install scancode-toolkit
      - name: Download source and scan component
        run: python scripts/download_and_scan.py --component "${{ matrix.component }}" --version "${{ matrix.version }}" --url "${{ matrix.url }}"
      - name: Upload ScanCode result
        uses: actions/upload-artifact@v4
        with:
          name: scancode-${{ matrix.component }}
          path: scan-results/${{ matrix.component }}.json

  aggregate:
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all ScanCode results
        uses: actions/download-artifact@v4
        with:
          path: scan-results
      - name: Aggregate copyrights
        run: python scripts/aggregate_copyrights.py
      - name: Upload copyrights artifact
        uses: actions/upload-artifact@v4
        with:
          name: copyrights
          path: copyrights.txt
